<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:FamilyFinance.ViewModels"
             xmlns:models="clr-namespace:FamilyFinance.Models"
             x:Class="FamilyFinance.Views.AccountPage"
             Title="Accounts">

    <Grid RowDefinitions="Auto,Auto,*,Auto">

        <!-- Balance Header -->
        <Frame Grid.Row="0" Margin="16,16,16,8" Padding="16"
               BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="12" HasShadow="True">
            <VerticalStackLayout HorizontalOptions="Center">
                <Label Text="Total Balance"
                       FontSize="14"
                       HorizontalTextAlignment="Center"
                       TextColor="Gray" />
                <Label x:Name="BalanceLabel"
                       Text="{Binding TotalBalance, StringFormat='{0:C2}'}"
                       FontSize="32"
                       FontAttributes="Bold"
                       HorizontalTextAlignment="Center"
                       TextColor="{Binding BalanceColor}" />
            </VerticalStackLayout>
        </Frame>

        <!-- Filter Buttons -->
        <HorizontalStackLayout Grid.Row="1" Spacing="8"
                                HorizontalOptions="Center" Margin="0,0,0,8">
            <Button Text="All"
                    Command="{Binding SetFilterCommand}"
                    CommandParameter="All"
                    BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                    TextColor="White"
                    CornerRadius="20"
                    HeightRequest="36"
                    FontSize="13" />
            <Button Text="Credit"
                    Command="{Binding SetFilterCommand}"
                    CommandParameter="Credit"
                    BackgroundColor="Green"
                    TextColor="White"
                    CornerRadius="20"
                    HeightRequest="36"
                    FontSize="13" />
            <Button Text="Debit"
                    Command="{Binding SetFilterCommand}"
                    CommandParameter="Debit"
                    BackgroundColor="Red"
                    TextColor="White"
                    CornerRadius="20"
                    HeightRequest="36"
                    FontSize="13" />
        </HorizontalStackLayout>

        <!-- Account List -->
        <CollectionView Grid.Row="2"
                        ItemsSource="{Binding FilteredAccounts}"
                        SelectionMode="Single"
                        SelectionChanged="OnAccountSelected">
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="20">
                    <Label Text="No accounts yet" FontSize="18" TextColor="Gray" HorizontalTextAlignment="Center" />
                    <Label Text="Tap + to add your first account" FontSize="14" TextColor="LightGray" HorizontalTextAlignment="Center" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Account">
                    <SwipeView>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete"
                                           BackgroundColor="Red"
                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:AccountViewModel}}, Path=DeleteAccountCommand}"
                                           CommandParameter="{Binding .}" />
                            </SwipeItems>
                        </SwipeView.RightItems>

                        <Frame Margin="16,4" Padding="12"
                               BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                               CornerRadius="10" HasShadow="True">
                            <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto" ColumnSpacing="12">
                                <!-- Credit/Debit Icon -->
                                <Label Grid.RowSpan="2"
                                       VerticalOptions="Center"
                                       FontSize="24">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsCredit}" Value="True">
                                            <Setter Property="Text" Value="▲" />
                                            <Setter Property="TextColor" Value="Green" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsCredit}" Value="False">
                                            <Setter Property="Text" Value="▼" />
                                            <Setter Property="TextColor" Value="Red" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>

                                <!-- Title and Details -->
                                <Label Grid.Column="1" Grid.Row="0"
                                       Text="{Binding Title}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       LineBreakMode="TailTruncation" />
                                <HorizontalStackLayout Grid.Column="1" Grid.Row="1" Spacing="8">
                                    <Label Text="{Binding Person.Name}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           IsVisible="{Binding Person, Converter={StaticResource IsNotNullConverter}}" />
                                    <Label Text="{Binding AccountType.Name}"
                                           FontSize="12"
                                           TextColor="Gray"
                                           IsVisible="{Binding AccountType, Converter={StaticResource IsNotNullConverter}}" />
                                </HorizontalStackLayout>

                                <!-- Amount -->
                                <Label Grid.Column="2" Grid.RowSpan="2"
                                       Text="{Binding Amount, StringFormat='{0:C2}'}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsCredit}" Value="True">
                                            <Setter Property="TextColor" Value="Green" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Label" Binding="{Binding IsCredit}" Value="False">
                                            <Setter Property="TextColor" Value="Red" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Grid>
                        </Frame>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- FAB -->
        <Button Grid.Row="3"
                Text="+"
                FontSize="28"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="0,0,20,20"
                Command="{Binding GoToAddAccountCommand}"
                Shadow="{OnPlatform Default={Shadow Brush=Black, Offset='2,4', Radius=8, Opacity=0.3}}" />
    </Grid>

</ContentPage>
