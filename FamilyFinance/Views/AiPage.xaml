<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:FamilyFinance.ViewModels"
             xmlns:models="clr-namespace:FamilyFinance.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="FamilyFinance.Views.AiPage"
             Title="AI Assistant">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="*,Auto,Auto">

        <!-- Chat Messages -->
        <CollectionView Grid.Row="0"
                        x:Name="MessagesCollection"
                        ItemsSource="{Binding Messages}"
                        ItemsUpdatingScrollMode="KeepLastItemInView"
                        Margin="0,8,0,0">
            <CollectionView.EmptyView>
                <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center" Padding="40">
                    <Label Text="AI Financial Assistant"
                           FontSize="22"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"
                           Margin="0,8,0,8" />
                    <Label Text="Tell me what financial records to create. For example:"
                           FontSize="14"
                           TextColor="Gray"
                           HorizontalTextAlignment="Center"
                           Margin="0,0,0,12" />
                    <Frame Padding="16" CornerRadius="12"
                           BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                           HasShadow="False" Margin="0,4">
                        <Label Text="&quot;Add $50 expense for groceries&quot;"
                               FontSize="14"
                               TextColor="Gray"
                               FontAttributes="Italic"
                               HorizontalTextAlignment="Center" />
                    </Frame>
                    <Frame Padding="16" CornerRadius="12"
                           BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                           HasShadow="False" Margin="0,4">
                        <Label Text="&quot;Payment of $200 from John for rent&quot;"
                               FontSize="14"
                               TextColor="Gray"
                               FontAttributes="Italic"
                               HorizontalTextAlignment="Center" />
                    </Frame>
                    <Frame Padding="16" CornerRadius="12"
                           BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                           HasShadow="False" Margin="0,4">
                        <Label Text="&quot;Register person Maria, phone 555-1234&quot;"
                               FontSize="14"
                               TextColor="Gray"
                               FontAttributes="Italic"
                               HorizontalTextAlignment="Center" />
                    </Frame>
                    <Label Text="You can also tap the microphone to use voice input."
                           FontSize="12"
                           TextColor="LightGray"
                           HorizontalTextAlignment="Center"
                           Margin="0,16,0,0" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:ChatMessage">
                    <Grid Padding="12,4">
                        <Frame MaximumWidthRequest="320"
                               Padding="14,10"
                               CornerRadius="16"
                               HasShadow="False"
                               BorderColor="Transparent">
                            <Frame.Triggers>
                                <DataTrigger TargetType="Frame" Binding="{Binding IsUser}" Value="True">
                                    <Setter Property="BackgroundColor" Value="#6200EE" />
                                    <Setter Property="HorizontalOptions" Value="End" />
                                </DataTrigger>
                                <DataTrigger TargetType="Frame" Binding="{Binding IsUser}" Value="False">
                                    <Setter Property="BackgroundColor"
                                            Value="{AppThemeBinding Light=#EEEEEE, Dark=#2A2A2A}" />
                                    <Setter Property="HorizontalOptions" Value="Start" />
                                </DataTrigger>
                            </Frame.Triggers>
                            <Label Text="{Binding Content}" FontSize="14"
                                   LineBreakMode="WordWrap">
                                <Label.Triggers>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsUser}" Value="True">
                                        <Setter Property="TextColor" Value="White" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Label" Binding="{Binding IsUser}" Value="False">
                                        <Setter Property="TextColor"
                                                Value="{AppThemeBinding Light=#212121, Dark=White}" />
                                    </DataTrigger>
                                </Label.Triggers>
                            </Label>
                        </Frame>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Processing Indicator -->
        <HorizontalStackLayout Grid.Row="1"
                               IsVisible="{Binding IsProcessing}"
                               HorizontalOptions="Start"
                               Padding="20,4"
                               Spacing="8">
            <ActivityIndicator IsRunning="{Binding IsProcessing}"
                               HeightRequest="18"
                               WidthRequest="18"
                               Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}" />
            <Label Text="Thinking..."
                   FontSize="13"
                   TextColor="Gray"
                   VerticalOptions="Center" />
        </HorizontalStackLayout>

        <!-- Input Area -->
        <Grid Grid.Row="2"
              ColumnDefinitions="*,Auto,Auto"
              Padding="12,8,12,12"
              ColumnSpacing="8"
              BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}">

            <Entry Grid.Column="0"
                   Text="{Binding UserInput}"
                   Placeholder="Describe a transaction..."
                   ReturnType="Send"
                   ReturnCommand="{Binding SendMessageCommand}"
                   IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}" />

            <!-- Microphone Button -->
            <Button Grid.Column="1"
                    FontSize="18"
                    WidthRequest="44"
                    HeightRequest="44"
                    CornerRadius="22"
                    Padding="0"
                    Command="{Binding ToggleRecordingCommand}"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding IsRecording}" Value="True">
                        <Setter Property="BackgroundColor" Value="#F44336" />
                        <Setter Property="Text" Value="&#x23F9;" />
                        <Setter Property="TextColor" Value="White" />
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding IsRecording}" Value="False">
                        <Setter Property="BackgroundColor"
                                Value="{AppThemeBinding Light=#E0E0E0, Dark=#444444}" />
                        <Setter Property="Text" Value="&#x1F3A4;" />
                    </DataTrigger>
                </Button.Triggers>
            </Button>

            <!-- Send Button -->
            <Button Grid.Column="2"
                    Text="&#x27A4;"
                    FontSize="18"
                    WidthRequest="44"
                    HeightRequest="44"
                    CornerRadius="22"
                    Padding="0"
                    BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                    TextColor="White"
                    Command="{Binding SendMessageCommand}"
                    IsEnabled="{Binding IsProcessing, Converter={StaticResource InvertedBoolConverter}}" />
        </Grid>
    </Grid>

</ContentPage>
